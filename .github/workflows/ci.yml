name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build and Publish (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '7.0.x'

      - name: Restore
        run: dotnet restore src\PrinterService

      - name: Build
        run: dotnet build src\PrinterService -c Release --no-restore

      - name: Test
        run: |
          dotnet test tests\PrinterService.Tests -c Release --no-build --nologo

      - name: Publish
        run: dotnet publish src\PrinterService -c Release -r win-x64 -o src\PrinterService\publish --no-build

      - name: Integration tests (start exe, call endpoints)
        shell: powershell
        run: |
          $publish = "${{ github.workspace }}\src\PrinterService\publish"
          $exe = Join-Path $publish 'PrinterService.exe'
          if (-not (Test-Path $exe)) { throw "Published exe not found: $exe" }
          Write-Output "Starting service exe in console mode (dry-run)"
          $env:DRY_RUN = '1'
          $proc = Start-Process -FilePath $exe -ArgumentList '--console' -NoNewWindow -PassThru
          try {
            $max = 30
            $ok = $false
            for ($i=0; $i -lt $max; $i++) {
              try { Invoke-RestMethod -Uri 'http://localhost:8080/printers' -Method Get -TimeoutSec 2 | Out-Null; $ok=$true; break } catch { Start-Sleep -Seconds 1 }
            }
            if (-not $ok) { throw 'Service did not respond in time' }
            Write-Output 'Calling GET /printers'
            $r = Invoke-RestMethod -Uri 'http://localhost:8080/printers' -Method Get
            Write-Output "Printers count: $($r.Count)"
            Write-Output 'Calling POST /print/base64 (dry-run)'
            $body = @{ printer = 'TEST'; data = 'SGVsbG8=' } | ConvertTo-Json
            $resp = Invoke-RestMethod -Uri 'http://localhost:8080/print/base64' -Method Post -Body $body -ContentType 'application/json'
            Write-Output "Response: $resp"
          }
          finally {
            Write-Output 'Stopping process'
            try { Stop-Process -Id $proc.Id -Force } catch { }
          }

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: printer-service-publish
          path: src\PrinterService\publish
